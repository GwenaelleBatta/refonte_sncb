define(function(a){function b(a){function b(){a.render(function(b){var f=document.createElement("div"),g=a.mainDocument.getElementById("_"+a.uuid),h=c.browserStorage.get(D)||d.STR_CWP_POSITION_DEFAULT;g.classList.add(h),b.appendChild(f),k=b,a.setElement(f),j.ractive=new Ractive({el:f,template:a.getCompiledTemplate("survey"),data:{phase:o,color:a.getField("color"),headerColor:window.tinycolor(a.getField("color")).isLight()?" dark":" light",survey_question:p.toHTML(q.parse(s)),survey_options:t,survey_options_items:u,survey_comment:p.toHTML(q.parse(w)),survey_comment_enable:v,survey_thanks:p.toHTML(q.parse(y)),survey_thanks_enable:x,trans:a.translate}});var i=c.browserStorage.get("cb_survey_value");if(i){var l=j.ractive.find('[data-rate="'+i+'"]');j.ractive.findAll(".cb-survey-option").forEach(function(a){a.classList.remove("cb-survey-option-active")}),l.classList.add("cb-survey-option-active"),z.rate=l.getAttribute("data-rate"),z.label=l.getAttribute("data-label"),z.class=l.getAttribute("data-class")}e()})}function e(){c.browserStorage.unbind("survey.*").bind("survey.cb_survey_status",function(b){switch(b){case l:case m:case n:j.ractive.set("phase",b);break;case"closed":c.browserStorage.unbind("survey.*"),a.setDone()}}),j.ractive.on("submitRate",function(a){var b=Array.prototype.slice.call(j.ractive.findAll(".cb-survey-option"));b.forEach(function(a){a.classList.remove("cb-survey-option-active")}),a.node.classList.add("cb-survey-option-active"),z.rate=a.node.dataset.rate,z.label=a.node.dataset.label,z.class=a.node.dataset.class,c.browserStorage.set("cb_survey_value",z.rate),A=!0,v&&(o=m,setTimeout(function(){var a=k?k.querySelectorAll("#survey_comment .cb_messageinput")[0]:null;a&&a.focus()},100),j._changePhase(o))}),j.ractive.on("submitSurvey",function(){v&&(B=!0,z.comment=r.sanitize(j.ractive.find("#survey_comment textarea").value)),f(),x?(c.browserStorage.remove("cb_survey_value"),o=n,j._changePhase(o)):h()}),j.ractive.on("closeSurvey",function(a){return h(),a.original&&a.original.preventDefault&&a.original.preventDefault(),!1})}function f(){var a=c.getTransport(),b=c.browserStorage.get("chatSessionId");a.executeRequest({url:c.getAPIEndpoint("/sitemonitor/v1/sources/"+c.getSourceHash()+"/chatsession/"+b+"/goals.json"),cache:!1,data:{goal_data:z,type:"survey"},success:function(){}})}function g(a){return a?(a.length&&a[0]&&a[0].id&&(a=a[0]),a):{}}function h(){c.browserStorage.set("cb_survey_status","closed"),c.browserStorage.remove("cb_survey_value"),A=!1,B=!1}function i(){C||(j.setRendered(!0),b())}var j=this,k=null,l=1,m=2,n=3,o=l,p=a.getService("cb_markdown"),q=a.getService("cb_custom_fields"),r=a.getService("cb_utils"),s=a.getField("survey_question"),t=a.getField("survey_options"),u=g(t).field_options,v=a.getField("survey_comment_enable")===!0,w=a.getField("survey_comment"),x=a.getField("survey_thanks_enable")===!0,y=a.getField("survey_thanks"),z={},A=!1,B=!1,C=!1,D=d.STR_CWP_POSITION+a.getBusinesscaseId();j._changePhase=function(a){return c.browserStorage.set("cb_survey_status",a),j.ractive.set("phase",a),!0},j.isRendered=function(){return C},j.setRendered=function(a){return C=a,this},j.startSurvey=function(){var a=c.browserStorage.get("cb_survey_status");return"undefined"!=typeof a&&(o=a),i(),!0},j.stopSurvey=function(){return c.browserStorage.unbind("survey.*").remove("cb_survey_status"),this.setRendered(!1),a.remove(),!0}}var c=a("sdk/cobrowser"),d=a("sdk/config");window.registerPlugin({type:"goals",context:"visitor",name:"goals_survey",scope:b,handlers:[{name:"start",execute:function(a){var b=c.browserStorage.get("chatSessionId"),d=c.browserStorage.get("cb_survey_status"),e=c.browserStorage.get("_cb_blocked"),f=a.getData("agentNick");"undefined"!=typeof b&&"false"!==b&&"skip"!==d&&"undefined"==typeof e&&f?this.startSurvey():(c.browserStorage.remove("cb_survey_status"),a.end())}},{name:"restart",execute:function(a){var b=c.browserStorage.get("chatSessionId"),d=a.getData("agentNick");"undefined"!=typeof b&&"false"!==b&&d?this.startSurvey(!0):a.end()}},{name:"stop",execute:function(){this.stopSurvey()}}]})});
//# sourceMappingURL=survey.js.map