define(function(a){function b(a){function b(){j(),k()}function e(){return window.parent.innerWidth>=d.CHAT_EXTEND_WIDTH_THRESHOLD&&Ga}function f(b){var c=b?"add":"remove";a.mainDocument.querySelector("#_"+a.uuid).classList[c]("__shopping"),a.mainDocument.getElementById("_"+a.uuid).classList.remove("extended"),ka&&ka.doActionInContext("toggleActive",b)}function g(b){var c=oa.ractive.get("main_classes");b?c?c+=" cb_chat_wrapper":c="cb_chat_wrapper":c&&(c=c.replace(/cb_chat_wrapper/g,"").replace(/\s+/g," "));var d=b?"add":"remove";a.mainDocument.getElementById("_"+a.uuid).classList[d]("extended"),Ha=Ga=b,oa.ractive&&oa.ractive.set("main_classes",c)}function h(b){var c=oa.ractive.get("main_classes")||null,d="extended-fullscreen",e=a.mainDocument.getElementById("_"+a.uuid);void 0===b&&(b=null===c||!c.includes("cb-"+d)),b?(c=(c||"")+" cb-"+d,e.classList.add(d)):(c=(c||"").replace(new RegExp(" cb-"+d,"g"),""),e.classList.remove(d)),oa.ractive.set("main_classes",c)}function i(a){var b=oa.ractive.get("innerWrapperClasses");b||(b=""),b=a?" full-screen":b.replace(/full-screen/g,"").replace(/\s+/g," "),oa.ractive.set("innerWrapperClasses",b)}function j(){_a.original_message||(_a.original_message=_a.message),_a.message=Ua.parse(_a.original_message)}function k(){oa.closing_text.original_message||(oa.closing_text.original_message=oa.closing_text.message),oa.closing_text.message=Ua.parse(oa.closing_text.original_message),oa.ractive.set("closing_text",oa.closing_text)}function l(){n(),db++,gb.stop()}function m(){!cb&&ab&&bb&&(a.publishEvent("chat_interaction"),cb=!0)}function n(){na.connectToServer()}function o(){var a=ha.querySelector("#cobrowsing-dialogcontent");a&&a.scrollHeight>0&&(a.scrollTop=a.scrollHeight)}function p(){ha.querySelector(".cb_messageinput").focus()}function q(){return a.mainDocument.querySelector("#_"+a.uuid).classList.contains("minimized")}function r(b){if(b&&b.internal&&"shopping_cart"!==b.internal.type)return!1;if(!a.getData("hasConnected"))return!1;for(var d=c.browserStorage.get("lastMessage"),e=0,f="",g=oa.messages.length-1;g>=0;g--){var h=oa.messages[g];if((!h.internal||"shopping_cart"===h.internal.type)&&h.agent){if(f||(f=h.nick),d&&h.uuid===d.uuid)break;e++}}return!(oa.ractive.get("countNewMessages")>9&&e>9)&&(e&&f&&oa.ractive.set("title",a.translate("agent_sent_message").replace("%agent%",f)),e>9&&(e="9+"),void oa.ractive.set("countNewMessages",e))}function s(){for(var b=null,c=oa.messages.length-1;c>=0;c--){var d=oa.messages[c];if(d.agent&&(!d.internal||"shopping_cart"===d.internal.type)){b=d;break}}t(b),oa.ractive.set("countNewMessages",0),oa.ractive.set("title",a.getField("title"))}function t(a){if(!a||!a.agent)return!1;var b=a||oa.messages[oa.messages.length-1],d=c.browserStorage.get("chatSessionId"),e=b?{uuid:b.uuid,agentName:b.nick,chatSessionId:d}:null;c.browserStorage.set("lastMessage",e)}function u(){var b=a.mainDocument.querySelector("#_"+a.uuid);q()?(s(),w(b)):Ga?(la.doActionInContext("CloseWrapper",function(){v(b)}),oa.wrapperTab&&oa.setTab(oa.wrapperTab)):v(b)}function v(b){var c=ha.querySelector(".cb_dialogminmax .glyphicon"),e=ha.querySelector(".cb_user"),f=ha.querySelector(".cb_logo"),i=ha.querySelector(".cb_dialogbar"),j=ha.querySelector(".cb_dialogbartitle");b=b||a.mainDocument.querySelector("#_"+a.uuid),q()||c.classList.contains("minimized")||(a.publishEvent("entrypoint_chat_minimized"),c.classList.remove("maximized"),c.classList.add("minimized"),b.classList.remove("maximized"),b.classList.add("minimized"),e.classList.remove("maximized_element"),f.classList.remove("maximized_element"),j.classList.add("visible-text"),i.classList.add("no-border"),a.mainDocument.querySelector("body").classList.add("chat-minimized"),Pa.toggleMobileView(oa,a,!1,Va.isMobileView()),g(!1),h(!1),ma&&ma.doActionInContext("ExtendedChatClosed"),b.blur(),window.parent.focus(),Va.setPluginUIState(a,d.CHAT_STATES.minimised),oa.isMinimized=!0,oa.ractive.set("isMinimized",oa.isMinimized),s())}function w(b){var c=ha.querySelector(".cb_dialogminmax .glyphicon"),e=ha.querySelector(".cb_user"),f=ha.querySelector(".cb_logo"),g=ha.querySelector(".cb_dialogbar"),h=ha.querySelector(".cb_dialogbartitle");b=b||a.mainDocument.querySelector("#_"+a.uuid),b.classList.contains("maximized")||c.classList.contains("maximized")||(b.classList.remove("cb-remove-transitions"),a.publishEvent("entrypoint_chat_maximized"),c.classList.remove("minimized"),c.classList.add("maximized"),e.classList.add("maximized_element"),f.classList.add("maximized_element"),h.classList.remove("visible-text"),b.classList.remove("minimized"),b.classList.add("maximized"),g.classList.remove("no-border"),a.mainDocument.querySelector("body").classList.remove("chat-minimized"),Va.isMobileView()&&!q()&&Pa.toggleMobileView(oa,a,!0,!0),Va.setPluginUIState(a,d.CHAT_STATES.maximised),oa.isMinimized=!1,oa.ractive.set("isMinimized",oa.isMinimized))}function x(b){var c=Object.assign({},b);return!(!c.uuid||oa.messages.find(function(a){return a.uuid===c.uuid}))&&(c.body=Pa.addTargetBlankAttr(Ra.toHTML(Pa.convertURLsIntoMarkdownUrls(Pa.sanitize(c.body),!0,100))),c.timestamp=c.timestamp||Pa.getTime(a.getLocale()),c.body=oa.emojisService.parseEmojis(c),c)}function y(b){var c;"string"==typeof b&&b.length>0&&(b=Pa.sanitize(b),c={from:"Me",type:"visitor",agent:!1,uuid:Pa.UUID(),timestamp:Pa.getTime(a.getLocale()),body:b},na.sendMessage(b,{uuid:c.uuid,stamp:1e6*Date.now()}),a.publishEvent("visitor_message"),bb=!0,m(),a.setData("hasChatted",!0),c.body=Pa.addTargetBlankAttr(Ra.toHTML(Pa.convertURLsIntoMarkdownUrls(Pa.sanitize(c.body),!0,100))),oa.addMessageToConversation(c),oa.ractive.set("newMessage",""),pa=Ea.ACTIVE,o(),p()),V()}function z(){oa.agent.agent_id=null,oa.agent.nick=null,na.reAssignChatSession(function(){ta=!1;var a=D(na.createInternalMessage("connect_with_another_agent","chat_forwarding"));na.sendInternalMessage(a),oa.messages=[],oa.positionMessagesBeforeMAM=0},function(){oa.processStateChange(Ea.NO_AVAILABILITY)})}function A(){a.watchData("availability",function(a){a&&oa.state===Ea.OFFLINE?oa.processStateChange(Ea.OTHER_AGENT):a||oa.state!==Ea.OTHER_AGENT||oa.processStateChange(Ea.OFFLINE)})}function B(){a.unWatchData("availability")}function C(b){return b.indexOf(Fa.DISABLED_BC)!==-1?a.translate("disabled_bc_error"):b}function D(b){switch(b.internal.type){case"opening_text":b.internal.body=Pa.addTargetBlankAttr(Ra.toHTML(b.internal.body)),_a.sent=!0,a.setData("opening_text_sent",_a.sent);break;case"info":b.internal.body=Pa.addTargetBlankAttr(Ra.toHTML(b.internal.body));break;case"chat_forwarding":Ua.setConversationAgent(b.internal.agent),k();break;case"cobrowsing":a.setData("cobrowsing_started",b.internal.body===a.getStaticTextFor("cobrowsing_start_message")),b.internal.body=a.translate(b.internal.body);break;case"invite_message":b.internal.body=Pa.addTargetBlankAttr(Ra.toHTML(b.internal.body));break;case"video_chat":b.internal.body=JSON.parse(Pa.desanitize(b.internal.body)),"video_chat_requested"===b.internal.body.subtype&&(b.internal.photo=oa.agent.photo,V()),ma.doActionInContext("processInternalMessage",b.internal.body);break;case"shopping_cart":b.internal.body=JSON.parse(Pa.desanitize(b.internal.body)),ka?(oa.ractive.set("chatHasProducts",!0),b.internal.body.shortDescription=Pa.stripTags(b.internal.body.description),wa.push(b.internal.body),ka.doActionInContext("addItem",b.internal.body),b.internal.body.inCart=Ta.isItemInCart(b.internal.body),xa[b.internal.body.sku]=b.internal.body.inCart,oa.ractive.set("cartItems",xa),ya=wa.length,oa.ractive.set("cartItemsCount",ya),ka.doActionInContext("updateView"),ka.doActionInContext("setCartListener",E),ka.doActionInContext("setRouteListener",F)):oa.ractive.set("disabledShoppingCart",!0)}return b}function E(){oa.ractive.set("cartItemsCount",wa.length)}function F(a){switch(a){case Ba:za=Ba,oa.ractive.set("shoppingCartPage",za);break;case Ca:za=Ca,oa.ractive.set("shoppingCartPage",za)}}function G(){const b=a.mainDocument.getElementById("_"+a.uuid),c=Va.isMobileView(),d={desktopType:oa.ractive.get("desktopType"),mobileType:oa.ractive.get("mobileType")};Qa.switchToMobile(b,d,c),Pa.toggleMobileView(oa,a,c&&!q(),c)}function H(a){if(a.agent&&a.agent_id&&(!oa.agent.agent_id||a.internal&&"chat_forwarding"===a.internal.type)){oa.agent.agent_id=a.agent_id,oa.agent.nick=a.nick,oa.agent.nickCroppedIfLong=a.nick.length>Na?a.nick.substring(0,Na)+"...":a.nick;var b=_(a)?aa(a):a.agent_id;ua[b]&&ua[b]instanceof Object?oa.agent.photo=ua[b]:delete oa.agent.photo,oa.ractive.set("agent",oa.agent)}}function I(){c.browserStorage.unbind("chat.*").bind("chat._cb_close_status",function(a){oa.processStateChange(a)});var b="closed"===c.browserStorage.get("_cb_close_status")?"closed":"connecting";oa.processStateChange(b),oa.ractive.set("title",a.getField("title")),oa.ractive.set("color",a.getField("color")),oa.ractive.set("no_availability_message",a.getNoAvailabilityMessage());var i="#ffffff"===a.getField("color")?d.DEFAULT_CHAT_TEXT_COLOR:a.getField("color");oa.ractive.set("iconsActiveColor",i);var j=window.tinycolor(a.getField("color")),k=j.isLight()?" dark":" light";oa.ractive.set("headerColor",k),a.setData("opening_text_enable",_a.enable),na.on(na._events.onMAM,function(b,d){J(d),a.setData("hasConnected",!0);var e=c.browserStorage.get("invite_message");if(e&&!Y())S(e,function(){L(),c.browserStorage.remove("invite_message")});else{var f=c.browserStorage.get("start_message_internal");f&&f.length>0||!_a.enable||Y()||Z()?L():R(L)}q()&&r(),o()}),na.on(na._events.onInboundMessage,function(b,c){c.agent&&(oa.messages.find(function(a){return a.uuid===c.uuid})||N(c,function(){H(c)}),"internal"in c&&c.internal||(a.publishEvent("agent_message"),ab=!0,m())),c.internal&&(c=D(c)),ea(c),c.should_hide_message||oa.addMessageToConversation(x(c)),"shopping_cart"!==c.internal.type&&c.internal||(q()?r(c):c.agent&&t(c)),o(),V()}),na.on(na._events.onChatStateUpdate,function(b,d){var e=ha.querySelector("#cobrowsing-dialogcontent"),f=Pa.isScrollAtBottom(e);if(d===Ea.CLOSED&&oa.state===Ea.ACTIVE&&oa.closedByVisitor===!1&&a.publishEvent("chat_closed_by_agent"),oa.processStateChange(d),d===Ea.CLOSED&&!oa.closedByVisitor){var g=a.getLastActiveTimestamp(),h=Date.now();g&&h-1e3*g>c.getSessionTimeout()&&a.end(),ma&&ma.doActionInContext("ChatClosed"),la&&la.doActionInContext("CloseWrapperForce")}(d===Ea.COMPOSING&&f||d===Ea.OFFLINE)&&o()}),oa.ractive.on("toggleOptionsMenu",function(){q()&&u(),Oa=!Oa,oa.ractive.set("isOptionsMenuShown",Oa)}),oa.ractive.on("toggleEndpointError",function(a){a&&a.original.preventDefault&&a.original.preventDefault();var b=ha.querySelector(".endpoint_dropdown");b.classList.toggle("folded"),eb=!eb,oa.ractive.set("toggleEndpointDiv",eb)}),oa.ractive.on("keyPressed",function(a){var b=oa.ractive.get("newMessage");13!==a.original.keyCode||a.original.shiftKey||(a.original.preventDefault(),b=b.replace(/\n/g,"\n\n"),y(b),oa.emojisService.closeEmojiPicker(oa))}),oa.ractive.on("sendMessage",function(a){var b=oa.ractive.get("newMessage");return a.original.preventDefault(),b=b.replace(/\n/g,"\n\n"),y(b),oa.emojisService.closeEmojiPicker(oa),!1}),oa.ractive.observe("newMessage",function(a){a&&a.length>0&&pa!==Ea.COMPOSING?(na.sendState(Ea.COMPOSING),pa=Ea.COMPOSING):"undefined"!=typeof a&&a.length<1&&pa===Ea.COMPOSING&&(na.sendState(Ea.ACTIVE),pa=Ea.ACTIVE)}),oa.ractive.on("closeChat",function(b){if(b&&b.original.preventDefault&&b.original.preventDefault(),oa.closing_text.enable&&na.sendInternalMessage(na.createInternalMessage(a.getField("cct_editor"),"info")),!oa.isInternalMessageClosedChatSent){var d=na.createInternalMessage("chat_closed_by_visitor","chat_closed");na.sendInternalMessage(d),oa.isInternalMessageClosedChatSent=!0}oa.state!==Ea.CLOSED&&oa.closedByVisitor===!1&&(oa.closedByVisitor=!0,a.publishEvent("chat_closed_by_visitor")),a.setData("chat_closed",!0),ma&&ma.doActionInContext("ChatClosed"),ka&&(ka.doActionInContext("ClosingChat"),oa.ractive.set("orderProducts",[]),f(!1)),g(!1),h(!1),oa.setTab(Ma.CHAT);var e=oa.closing_text.enable&&oa.state!==Ea.NO_AVAILABILITY&&"undefined"==typeof c.browserStorage.get("_cb_close_status"),i=e?Ea.CLOSED:Ea.DONE;return na.sendState(Ea.CLOSED,void 0,function(){c.browserStorage.set("_cb_close_status",i),na.tearDown(),o()}),!1}),oa.ractive.on("reconnect",function(a){return n(),a&&a.original.preventDefault&&a.original.preventDefault(),!1}),oa.ractive.on("reconnect_on_countdown",function(a){return l(),a&&a.original.preventDefault&&a.original.preventDefault(),!1}),oa.ractive.on("connect_with_other_agent",function(a){a&&a.original.preventDefault&&a.original.preventDefault(),oa.processStateChange(Ea.CONNECTING),z()}),oa.ractive.on("minChat",function(a){return u(),a&&a.original.preventDefault&&a.original.preventDefault(),!1}),oa.ractive.on("showShoppingCart",function(a){var b=a.node.attributes["data-item"],c=!(!b||"prefilled"!==b.value),d=oa.ractive.get("tab")===Ma.SHOPPING_CART;if(d){var e=c&&za!==Ba,g=!c&&za!==Ca;return(e||g)&&(za=c?Ba:Ca,oa.ractive.set("shoppingCartPage",za),ka.doActionInContext("showCartPage",c)),!1}za=Ba,oa.ractive.set("shoppingCartPage",za),Ga=!0,la.doActionInContext("wrapChildPlugin",ka),la.render(ha.querySelector(Da.INNER_CONTAINER_ID)),oa.setTab(Ma.SHOPPING_CART),f(!0),a&&a.original.preventDefault&&a.original.preventDefault(),ka.doActionInContext("showCartPage",!0)}),oa.ractive.on("showChat",function(a){return"chat"!==oa.ractive.get("tab")&&(a&&a.original.preventDefault&&a.original.preventDefault(),oa.onShowChat(),!1)}),oa.ractive.on("showVideo",function(a){a&&a.original.preventDefault&&a.original.preventDefault(),oa.setTab(Ma.VIDEO_CHAT),oa.ractive.set("activeChannel","video")}),oa.ractive.on("startVideoChat",function(a){return Ga=!0,Ka=!1,oa.ractive.set("showVideoInvite",Ka),la.doActionInContext("wrapChildPlugin",ma),e()?(g(!0),la.render(ha.querySelector(Da.OUTER_CONTAINER_ID)),ma.doActionInContext("ExtendedChatOpen")):(la.render(ha.querySelector(Da.INNER_CONTAINER_ID)),ma.doActionInContext("ExtendedChatOpen"),oa.setTab(Ma.VIDEO_CHAT),oa.ractive.set("activeChannel","video"),oa.ractive.set("showVideoTab",!0),oa.ractive.set("displayTabs",!0),oa.wrapperTab="video"),a&&a.original.preventDefault&&a.original.preventDefault(),!1}),oa.ractive.on("declineVideoChat",function(){var b={from:"Agent",type:"agent",agent:!0,timestamp:Pa.getTime(a.getLocale()),body:"video_chat",internal:{type:"video_chat",body:{subtype:"video_chat_declined",id:La}}};oa.addMessageToConversation(b),b.internal.body=Pa.sanitize(b.internal.body),na.sendInternalMessage(b),Ka=!1,La=null,oa.ractive.set("showVideoInvite",Ka),o()}),oa.ractive.on("showChat",function(a){return"chat"!==oa.ractive.get("tab")&&(a&&a.original.preventDefault&&a.original.preventDefault(),oa.onShowChat(),!1)}),oa.ractive.on("focusInputArea",function(){oa.emojisService.closeEmojiPicker(oa)}),a.watchData("cobrowsing",W),c.browserStorage.bind("kernel.pluginUIStates",function(){if(oa.isRendered){var b=Va.isPluginUIStateMaximized(a.uuid),c=Va.isPluginUIStateMinimized(a.uuid);b&&oa.isMinimized?w():c&&!oa.isMinimized&&v()}}),window.parent.addEventListener("resize",G);var p;"function"==typeof Event?p=new Event("resize"):(p=document.createEvent("Event"),p.initEvent("resize",!0,!0)),window.parent.dispatchEvent(p),o(),na.on(na._events.onCustomCbAcceptedClick,function(){u()})}function J(a){var b=[];a.forEach(function(a){if(!a.internal||"visitor_forward_message"!==a.internal.type||"visitor_forward_message"!==a.internal.body){"visitor_forward_message"===a.internal.body&&(a.agent=!0),"internal"in a&&a.internal||(ab=ab||a.agent,bb=bb||!a.agent,cb=ab&&bb);var c=Object.assign({},a);if(c.uuid&&!oa.messages.find(function(a){return a.uuid===c.uuid}))if(c.agent&&N(c),c.internal){if(_a.sent===!0&&"opening_text"===c.internal.type)return;if(T()===!0&&"invite_message"===c.internal.type)return;c.internal.body=Pa.sanitize(c.internal.body),c=D(c),b.push(c)}else b.push(x(c))}}),oa.addMessagesTo(b,oa.positionMessagesBeforeMAM)}function K(b){oa.isRendered?b():(oa.isRendered=!0,a.publishEvent("entrypoint_chat_display"),a.render(function(d){switch(oa.render(d),na.connectToServer(),c.browserStorage.get("_cb_close_status")){case Ea.CLOSED:case Ea.DONE:a.getData("hasChatted")||a.publishEvent("entrypoint_no_availability_chatting",a.getPreviousPlugin());break;default:gb.init()}I(),b()}))}function L(){var a=c.browserStorage.get("start_message"),b=c.browserStorage.get("start_message_internal");a&&(y(a),c.browserStorage.remove("start_message")),b&&b.length&&(b.forEach(function(a){var b=na.createInternalMessage(a.body,a.type);b.uuid=Pa.UUID(),na.sendInternalMessage(b),b.internal.body=Pa.addTargetBlankAttr(Ra.toHTML(b.internal.body)),oa.messages.push(b)}),oa.ractive.set("messages",oa.messages),c.browserStorage.remove("start_message_internal")),oa.ractive.set("startMessagesSent",!0)}function M(){var a=na.getChatHistory();return!!a&&(oa.positionMessagesBeforeMAM=oa.messages.length,!0)}function N(a,b){var c=_(a),d=c?aa(a):a.agent_id,e=ua.hasOwnProperty(d),f=e&&ua[d]&&ua[d]instanceof Object;f?(ba()&&(a.photo=ua[d]),"function"==typeof b&&b()):a.agent&&a.agent_id&&("loading"!==ua[d]?(va[d]=[],O(a.agent_id,b,c&&"string"==typeof d?d.split(":"):[])):"function"==typeof b&&va[d].push(b))}function O(a,b,c){var d=Array.isArray(c)&&c.length?c.join(":"):a;"loading"!==ua[d]&&(ua[d]="loading",na.getAgentProfilePhoto(a,function(a){var c=!1;a&&a.base64icon?(ua[d]=a,oa.messages.forEach(function(a){if("chat"!==a.type&&"agent"!==a.type||a.photo||!a.agent)_(a)&&ba()&&(a.photo=ua[d],c=!0);else{var b=_(a)?aa(a):a.agent_id;b===d&&(a.photo=ua[d],c=!0)}}),c&&oa.ractive.set("messages",oa.messages)):ua[d]=null,"function"==typeof b&&b();var e=va[d].shift();if(d in va)for(;e;)e(),e=va[d].shift()},Array.isArray(c)?c:[]))}function P(){if(!sa){var b=na.createInternalMessage(a.getClientUrl(),"visitor_current_url");na.sendInternalMessage(b),sa=!0}}function Q(){if(ta){var a;ta=!1,a=na.createInternalMessage("visitor_forward_message","chat_forwarding"),na.sendInternalMessage(a),oa.addMessageToConversation(a)}}function R(b){var c,d=oa.messages.some(function(a){return!a.internal||"video_chat"===a.internal.type});X()?(c=na.createInternalMessage(_a.message,"opening_text"),na.sendInternalMessage(c,b),c=D(c),_a.sent=!0,a.setData("opening_text_sent",_a.sent),oa.addMessageToConversation(c),U()):_a.enable!==!0||d||_a.sent!==!0||U(),oa.ractive.set("openingTextSent",!0)}function S(a,b){if(!T()){var c=na.createInternalMessage(a,"invite_message");na.sendInternalMessage(c,b),c=D(c),oa.addMessageToConversation(c)}}function T(){var a=!1;return oa.messages.forEach(function(b){b.internal&&b.internal.type&&"invite_message"===b.internal.type&&(a=!0)}),a}function U(){var a=oa.ractive.find(".cb_opening_text");!ga&&_a.visual_reminder&&(Sa.bounce(a,0,10),ga=window.parent.setInterval(function(){Sa.bounce(a,0,10)},5e3))}function V(){ga&&(window.parent.clearInterval(ga),ga=null)}function W(b){if(b&&"boolean"==typeof b.active&&b.msg&&oa.state!==Ea.CLOSED){var c={from:"Me",type:"visitor",agent:!1,timestamp:Pa.getTime(a.getLocale()),body:Pa.sanitize(b.msg),internal:{type:"cobrowsing",body:Pa.sanitize(b.msg)}};na.sendInternalMessage(c),c=D(c),oa.addMessageToConversation(c);var d=Va.isPluginUIStateMaximized(a.uuid);d&&w()}}function X(){var a=!0;return oa.messages.forEach(function(b){b.internal&&b.internal.type&&"opening_text"===b.internal.type&&(a=!1)}),_a.enable===!0&&""!==_a.message&&_a.sent===!1&&a}function Y(){return oa.messages.find(function(a){if(a.internal&&a.internal.type&&"invite_message"===a.internal.type)return!0})}function Z(){return!!oa.messages.find(function(a){if(a.internal&&a.internal.type&&"info"===a.internal.type)return!0})}function $(a){return a.internal&&a.internal.type&&"agentinfo"===a.internal.type}function _(a){return a.agent&&a.hasOwnProperty("user_group_share_id")&&a.user_group_share_id}function aa(a){return[a.user_group_share_id,a.fake_profile_id].join(":")}function ba(){return"classic"===a.getTheme()}function ca(){return"modern"===a.getTheme()}function da(a){return a===ra}function ea(b){b.internal||(window.top.document[Wa.getHidden()]&&b.agent?Wa.isMessageRead()?(Wa.setMessage(a.translate("unread_message")),Wa.registerVisibilityChangeEvent(),Wa.handleVisibilityChange()):c.browserStorage.get("isLastMessageRead")||Wa.playSound():!window.top.document[Wa.getHidden()]&&b.agent&&setTimeout(function(){c.browserStorage.set("isLastMessageRead",!0)},10))}var fa,ga,ha,ia,ja,ka,la,ma,na,oa=this,pa="active",qa="liveChat",ra="whatsapp",sa=!1,ta=!1,ua={},va=[],wa=[],xa={},ya=0,za="",Aa="none",Ba="shopping-products-visitor",Ca="shopping-cart-visitor",Da={INNER_CONTAINER_ID:"#wrapper_inner_container",OUTER_CONTAINER_ID:"#wrapper_outer_container"},Ea={ACTIVE:"active",CLOSED:"closed",OFFLINE:"offline",NO_AVAILABILITY:"no_availability",COMPOSING:"composing",CONNECTED:"connected",DONE:"done",OTHER_AGENT:"other_agent",CONNECTING:"connecting",ERROR:"error",PICKING:"picking",BACKEND_ERROR:"backend_error",COOKIES_MISSING:"cookies_missing",ENDPOINT_ERROR:"endpoint_error",BLOCKED:"blocked"},Fa={DISABLED_BC:"CHAT_CAMPAIGN_INACTIVE"},Ga=!1,Ha=!1,Ia=!1,Ja=a.getField("campaignFeatures")||[],Ka=!1,La=null,Ma={CHAT:"chat",SHOPPING_CART:"cart",VIDEO_CHAT:"video"},Na=15,Oa=!1,Pa=a.getService("cb_utils"),Qa=a.getService("cb_button_switch"),Ra=a.getService("cb_markdown"),Sa=a.getService("cb_animate"),Ta=a.getService("cb_shopping_cart"),Ua=a.getService("cb_custom_fields"),Va=a.getService("cb_visitor_utils"),Wa=a.getService("cb_unread_message"),Xa=d.STR_CWP_POSITION+a.getBusinesscaseId(),Ya=d.STR_CWP_MINIMIZE_DESKTOP_TYPE+a.getBusinesscaseId(),Za=d.STR_CWP_MINIMIZE_MOBILE_TYPE+a.getBusinesscaseId(),$a=d.CAMPAIGN_FEATURES_DEFAULTS,_a={enable:a.getField("cot_enable")===!0,message:a.getField("cot_editor")||"",visual_reminder:a.getField("cot_visual_reminder"),sent:!1},ab=!1,bb=!1,cb=!1,db=0,eb=!1,fb=[1,5,15,30],gb={_timerID:null,_seconds:null,init:function(){oa.ractive.set("connection_retry",db),db<3&&(this._seconds=fb[db],oa.ractive.set("seconds",this._seconds))},start:function(){null===this._timerID&&db<3&&(this._timerID=window.setInterval(function(){gb.countDown()},1e3))},stop:function(){null!==this._timerID?(window.clearInterval(this._timerID),this._timerID=null):db=0,this.init()},isRunning:function(){return db>0},countDown:function(){this._seconds<1&&(n(),db++,this.stop()),oa.ractive.set("seconds",this._seconds),this._seconds--}};oa.navigator=Pa.isIpadIOS11(navigator.userAgent)?"ipad-ios11":"",oa.messages=[],oa.agent={agent_id:null},oa.positionMessagesBeforeMAM=oa.messages.length,oa.connectedFirstTime=!1,oa.isMobile=Pa.isMobile(navigator.userAgent),oa.isTablet=Pa.isTablet(navigator.userAgent),oa.isIpad=Pa.isIpad(navigator.userAgent),oa.isIPhone=Pa.isIphone(navigator.userAgent),oa.closedByVisitor=!1,oa.isInternalMessageClosedChatSent=!1,oa.isRendered=!1,oa.showPicker=!1,oa.emojisService=a.getService("cb_emojis_service"),oa.orderProducts=[],oa.closing_text={enable:a.getField("cct_enable")===!0&&!a.isPlugin("goals_survey"),message:Pa.addTargetBlankAttr(Ra.toHTML(a.getField("cct_editor")))},oa.addMessagesTo=function(a,b){var c="undefined"==typeof b?oa.messages.length:b,d=oa.messages.slice(0,c),e=oa.messages.slice(c);Array.prototype.push.apply(d,a),oa.messages=d.concat(e),Pa.setMessageTypeToMessages(oa.messages),oa.ractive.set("messages",oa.messages)},oa.addMessageToConversation=function(a){a===!1||$(a)||(a.body=oa.emojisService.parseEmojis(a),oa.messages.push(a),Pa.setMessageTypeToMessages(oa.messages),oa.messages=oa.messages.sort(function(a,b){return Number(a.stamp)-Number(b.stamp)}),oa.ractive.set("messages",oa.messages))},oa.onShowChat=function(){oa.ractive.get("tab")===Ma.SHOPPING_CART&&f(!1),oa.setTab(Ma.CHAT),ia&&ia.doActionInContext("start",ha),oa.emojisService.renderEmojiPicker(a,ha),setTimeout(function(){o()},150)},oa.onShowWhatsAppTab=function(){oa.setTab(Ma.CHAT)},oa.onShowSuccessOrderProducts=function(){Ta.getOrderProducts(function(a){oa.orderProducts=a.data,oa.ractive.set("orderProducts",oa.orderProducts)})};var hb={connected:{order:2,force:!1,name:Ea.CONNECTED,func:function(){b(),M(),oa.processStateChange(Ea.ACTIVE)}},active:{order:3,force:!1,name:Ea.ACTIVE,func:function(a){B(),Q(),gb.stop(),oa.connectedFirstTime=!0,P(),ja&&a&&a.name===Ea.CONNECTED&&ja.doActionInContext("chatStarted"),c.stopAvailabilityPoller()}},composing:{order:3,force:!1,name:Ea.COMPOSING},closed:{order:4,force:!1,name:Ea.CLOSED,func:function(){k(),V(),Pa.toggleMobileView(oa,a,!1,!1),g(!1),oa.setTab(Ma.CHAT),f(!1),window.parent.removeEventListener("resize",G)}},done:{order:5,force:!1,name:Ea.DONE,func:function(b){a.setData("agentNick",oa.agent.nick),b&&b.name===Ea.NO_AVAILABILITY&&a.isPlugin("goals_survey")&&c.browserStorage.set("cb_survey_status","skip"),Pa.toggleMobileView(oa,a,!1,!1),window.parent.removeEventListener("resize",G),a.end(),c.pollAvailability()}},backend_error:{order:10,force:!1,name:Ea.BACKEND_ERROR},cookies_missing:{order:1,force:!0,name:Ea.COOKIES_MISSING},endpoint_error:{order:1,force:!0,name:Ea.ENDPOINT_ERROR,func:function(){oa.ractive.set("endpoint_error",C(na.endpoint_error))}},connecting:{order:1,force:!0,name:Ea.CONNECTING},no_availability:{order:1,force:!0,name:Ea.NO_AVAILABILITY},offline:{order:1,force:!0,name:Ea.OFFLINE,func:function(){A(),a.getData("availability")&&oa.processStateChange(Ea.OTHER_AGENT),oa.connectedFirstTime===!1&&a.publishEvent("entrypoint_no_availability_chatting",a.getPreviousPlugin()),c.pollAvailability()}},other_agent:{order:1,force:!0,name:Ea.OTHER_AGENT,func:function(){A()}},error:{order:1,force:!0,name:Ea.ERROR,func:function(){gb.start()}},blocked:{order:1,force:!0,name:Ea.BLOCKED,func:function(){na.setVisitorBlocked(!0),oa.processStateChange("done")}},picking:{order:1,force:!0,name:Ea.PICKING}};oa.processStateChange=function(a){if("undefined"==typeof a||!(a in hb))return void(window.console&&window.console.log("[CB] could not process state ",a));a=hb[a];var b=hb[oa.state];if(a.force||"undefined"==typeof b||b.force||a.name!==b.name&&a.order>=b.order){if(b&&b.name===Ea.CLOSED&&a&&a.name!==Ea.DONE)return;oa.state=a.name,oa.ractive.set("state",a.name),"func"in a&&a.func(b)}},oa.render=function(b){a.setData("chatHasStarted",!0);const e=document.createElement("div"),f=a.mainDocument.querySelector("#_"+a.uuid),g=c.browserStorage.get(Xa)||d.STR_CWP_POSITION_DEFAULT,h=c.browserStorage.get(Ya)||d.CHAT_BUTTON_TYPES.BAR,i=c.browserStorage.get(Za)||d.CHAT_BUTTON_TYPES.BUBBLE;ha=b,b&&b.appendChild&&b.appendChild(e),oa.isMinimized=Va.isPluginUIStateMinimized(a.uuid),f.classList.add(g),oa.ractive=new Ractive({el:e,template:a.getCompiledTemplate("chat"),data:{navigator:oa.navigator,messages:oa.messages,isOptionsMenuShown:Oa,theme:a.getTheme(),openingTextSent:!1,startMessagesSent:!1,trans:a.translate,setButtonLink:oa.setButtonLink,toggleChatScreen:oa.toggleChatScreen,showPicker:oa.showPicker,activeChannel:qa,position:g,isMinimized:oa.isMinimized,desktopType:h,mobileType:i,endpoint_error:na.endpoint_error,noAvailabilityMessage:a.getNoAvailabilityMessage()||a.translate("no_available_agents"),SHOPPING_PREFILLED_CART_PAGE:Ba,SHOPPING_CART_PAGE:Ca}}),oa.ractive.set("tab",Ma.CHAT),oa.setTab(Ma.CHAT),f.classList.add(g),oa.isMinimized?(f.classList.add("cb-remove-transitions"),v(f)):w(f),a.fetchLogo(function(a){null!==a&&oa.ractive.set("logo",a)}),oa.ractive.set("hostname",c.hostname),oa.ractive.set("INVENTORY_TRACKING_NONE",Aa),oa.ractive.on("toggleChatScreen",oa.toggleChatScreen),oa.ractive.set("showVideoInvite",Ka),oa.ractive.set("navigateToLink",function(a){window.open(a)}),oa.ractive.on("togglePicker",function(){oa.showPicker=!oa.showPicker,oa.ractive.set("showPicker",oa.showPicker)})},oa.startChat=function(b){return na=a.getService("cb_chat"),Va.initPluginUIState(a),b||a.enforceBusinessCase(),K(function(){a.getChildPluginInstance("cobrowsing",function(a){a&&a.active&&(ia=a,a.doActionInContext("start",ha))}),a.getChildPluginInstance("chat_wrapper",function(a){a&&a.active&&ca()&&(la=a,a.doActionInContext("start"),la.render(ha.querySelector(Da.INNER_CONTAINER_ID)))}),a.getChildPluginInstance("video_chat",function(b){if(b&&b.active&&(ma=b,ma.doActionInContext("start",na,ha)),oa.ractive.set("video_chat",ma),ma){var c=a.mainDocument.querySelector("#_"+a.uuid);c.contentWindow.addEventListener("message",function(a){var b=a.data;b.type&&b.type.startsWith("WESEEDO_")&&ma.doActionInContext("ProcessEvent",b)})}}),"modern"===a.getTheme()&&a.getChildPluginInstance("shopping_cart",function(a){a&&a.active&&(ka=a,Ia=ka.isExtendable(),ka.doActionInContext("start",na,ha),ka.doActionInContext("setFullScreenListener",i),oa.onShowSuccessOrderProducts()),oa.ractive.set("shopping_cart",ka)}),a.getChildPluginInstance("visit_track",function(a){a&&a.active&&c.browserStorage.getAllowTracking()&&(ja=a,a.doActionInContext("start",na))}),a.getChildPluginInstance("sneak_preview",function(a){a&&a.active&&c.getPrivacyLevel()&&(fa=a,a.doActionInContext("start",oa.ractive,na,ha))}),oa.emojisService.renderEmojiPicker(a,ha),oa.renderWhatsappChannel(),oa.ractive.set("campaignFeatureDefault",$a),oa.ractive.set("campaignFeatures",Ja),oa.ractive.set("displayTabs",Ja.length>0)}),!0},oa.onDisplayVideoChatInvite=function(a){a?(La=a.id,a=a.url):(La=null,a=!1),setTimeout(function(){oa.ractive.set("videoMeetingId",La),oa.ractive.set("showVideoInvite",a),o()},500)},oa.onCloseExtendedChat=function(a){oa.setTab(Ma.CHAT),oa.ractive.set("activeChannel","liveChat"),g(!1),"video_chat"===a.getPluginName()&&(oa.ractive.set("displayTabs",Ja.length>0),oa.ractive.set("showVideoTab",!1),Ga=!1,oa.wrapperTab=null)},oa.onToggleExtendedChatFullscreen=function(){h()},oa.stopChat=function(){return!!oa.isRendered&&(Pa.toggleMobileView(oa,a,!1,!1),window.parent.removeEventListener("resize",G),oa.isRendered=!1,c.browserStorage.unbind("chat.*").remove("_cb_close_status"),a.remove(),ia&&ia.doActionInContext("stop"),ja&&ja.doActionInContext("stop"),fa&&fa.doActionInContext("stop"),s(),!0)},oa.navigateToUrl=function(a){window.open(a,"_blank")},oa.renderWhatsappChannel=function(){var a=Ja.find(function(a){return a.type===ra});if(a){var b=$a.whatsapp.href+a.value;QRCode.toCanvas(oa.ractive.find("#canvas_qr_code"),b),oa.ractive.set("whatsappLink",b)}},oa.setButtonLink=function(a,b){da(a)?oa.toggleChatScreen(a,"#cobrowsing-dialogcontent"):oa.navigateToUrl($a[a].href+b)},oa.toggleChatScreen=function(a,b){"liveChat"===a?oa.onShowChat():"whatsapp"===a?(oa.onShowWhatsAppTab(),oa.renderWhatsappChannel()):oa.setTab(a),oa.emojisService.closeEmojiPicker(oa),oa.ractive.set("activeChannel",a),b&&Pa.scrollToBottomBlock(oa.ractive.find(b))},oa.onSelectEmoji=function(a){oa.ractive.set("newMessage",a)},oa.setTab=function(a){oa.ractive.set("tab",a)}}var c=a("sdk/cobrowser"),d=a("sdk/config");window.registerPlugin({type:"chat",context:"visitor",name:"chat_cobrowser",scope:b,handlers:[{name:"start",execute:function(){this.startChat()}},{name:"stop",execute:function(){this.stopChat()}}]})});
//# sourceMappingURL=chat.js.map